<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="keywords" content="HTML5 Template" />
    <meta
      name="description"
      content="Webster - Responsive Multi-purpose HTML5 Template"
    />
    <meta name="author" content="potenzaglobalsolutions.com" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <title>FavSpot - Follower</title>

    <!-- Favicon -->
    <link
      rel="shortcut icon"
      href="https://everyplacetest.s3.ap-northeast-2.amazonaws.com/dev/fav.png"
    />

    <!-- font -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Montserrat:300,300i,400,500,500i,600,700,800,900|Poppins:200,300,300i,400,400i,500,500i,600,600i,700,700i,800,800i,900"
    />

    <!-- Plugins -->
    <link
      rel="stylesheet"
      type="text/css"
      href="../css/template/plugins-css.css"
    />

    <!-- Typography -->
    <link
      rel="stylesheet"
      type="text/css"
      href="../css/template/typography.css"
    />

    <!-- Shortcodes -->
    <link
      rel="stylesheet"
      type="text/css"
      href="../css/template/shortcodes/shortcodes.css"
    />

    <!-- Style -->
    <link rel="stylesheet" type="text/css" href="../css/template/style.css" />

    <!-- shop -->
    <link href="../css/template/shop.css" rel="stylesheet" type="text/css" />

    <!-- Responsive -->
    <link
      rel="stylesheet"
      type="text/css"
      href="../css/template/responsive.css"
    />
  </head>

  <body>
    <div id="main-container">
      <!--=================================
shop -->

      <section class="wishlist-page page-section-ptb" style="height: 98.75%">
        <div class="container">
          <div class="row">
            <div class="col-lg-12 col-md-12">
              <div class="section-title text-center">
                <h6 class="">Check User Follower List</h6>
                <h2 class="title-effect">Follower</h2>
              </div>

              <div id="main" class="row">
                <div class="col-lg-3">
                  <div class="sidebar-widget">
                    <div class="team team-round full-border">
                      <div class="team-photo">
                        <img
                          id="profileImg"
                          class="img-fluid mx-auto"
                          style="object-fit: cover; width: 215px; height: 215px"
                          src="https://everyplacetest.s3.ap-northeast-2.amazonaws.com/dev/user_default_clear.png"
                          alt=""
                        />
                      </div>
                      <div class="team-description">
                        <div class="team-info">
                          <h6 id="email"></h6>
                          <span id="nickname"></span>
                        </div>
                        <div>
                          <i class="fa fa-user"></i>
                          <a id="followers" href="#">
                            <span class="followers fw-bold small"></span>
                            <span class="small">followers</span>
                          </a>
                          <span>|</span>
                          <a id="following" href="#">
                            <span class="following fw-bold small"></span>
                            <span class="small">following</span>
                          </a>
                          <div class="changeBtn"></div>
                        </div>
                      </div>
                    </div>
                  </div>

                </div>
                <div class="table-responsive col-lg-9">
                  <table class="table">
                    <thead>
                      <tr id="followTr">
                        <th>Profile Image</th>
                        <th>Email</th>
                        <th>Nickname</th>
                      </tr>
                    </thead>
                    <tbody id="followList"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
    <!--=================================
shop -->

    <!--=================================
 jquery -->

    <script type="module">
      import { createPreloader } from '../js/util/preloader.js';
      import { createHeader } from '../js/util/header.js';
      import { createFooter } from '../js/util/footer.js';
      createPreloader();
      createHeader();
      createFooter();
    </script>

    <!-- jquery -->
    <script src="../js/template/jquery-3.6.0.min.js"></script>

    <!-- plugins-jquery -->
    <script src="../js/template/plugins-jquery.js"></script>

    <!-- plugin_path -->
    <script>
      var plugin_path = '../js/template/';
    </script>

    <!-- plugins-jquery -->
    <script
      type="text/javascript"
      src="../js/template/slick/slick.min.js"
    ></script>

    <!-- custom -->
    <script src="../js/template/custom.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        fetch(`http://127.0.0.1:8000/user/me/`, {
          method: 'GET',
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json',
          },
        })
          .then((response) => response.json())
          .then((data) => {
            const requestUser = data.results.User.email;
            const requestUserPk = data.results.User.id;
            const followingList = data.results.User.following_list;
            const requestUserProfileImg = data.results.User.profile_img;

            if (requestUser) {
              const email = document.querySelector('#headerEmail');
              email.textContent = requestUser;
              const profileImg = document.querySelector('.profileImg');
              if (requestUserProfileImg) {
                profileImg.src = requestUserProfileImg;
                profileImg.style.borderRadius = '50%';
              }
            }

            const params = new URLSearchParams(window.location.search);
            let pk = params.get('pk');
            if (!pk) {
              pk = 'me';
            }

            const tagList = document.getElementById('tagList');

            fetch(`http://127.0.0.1:8000/user/${pk}/`, {
              method: 'GET',
              credentials: 'include',
            })
              .then((response) => response.json())
              .then((data) => {
                // 가져온 사용자 데이터를 폼 필드에 채워줍니다.
                const email = document.querySelector('#email');
                email.textContent = data['results']['User']['email'];
                const nickname = document.querySelector('#nickname');

                if (data['results']['User']['nickname']) {
                  nickname.textContent = data['results']['User']['nickname'];
                } else {
                  nickname.textContent = 'None';
                }
                const img = data['results']['User']['profile_img'];
                const profileImg = document.getElementById('profileImg');
                if (img) {
                  profileImg.src = img;
                }
                let followers = document.querySelector('.followers');
                followers.textContent = data['results']['User']['followers'];
                followers = document.querySelector('#followers');
                followers.addEventListener('click', (event) => {
                  window.location.href = `follower.html?pk=${pk}`;
                });

                let following = document.querySelector('.following');
                following.textContent = data['results']['User']['following'];
                following = document.querySelector('#following');
                following.addEventListener('click', (event) => {
                  window.location.href = `following.html?pk=${pk}`;
                });

                const button = document.createElement('a');
                button.type = 'button';
                button.classList.add('btn', 'btn-primary');
                button.style.display = 'block';

                // 기존 요소에 버튼 추가
                const changeBtnDiv = document.querySelector('.changeBtn');
                if ((requestUserPk === parseInt(pk)) | (pk == 'me')) {
                  button.textContent = 'Profile Edit';
                  button.setAttribute('href', 'profile_edit.html');
                } else if (
                  followingList.includes(data['results']['User']['email'])
                ) {
                  button.textContent = 'Unfollow';
                  button.addEventListener('click', () => {
                    fetch(`http://127.0.0.1:8000/user/follow/${pk}/`, {
                      method: 'DELETE',
                      credentials: 'include',
                      headers: {
                        'Content-Type': 'application/json',
                      },
                    })
                      .then((response) => {
                        if (response.status === 204) {
                          location.reload(); // 페이지 새로고침
                        } else {
                          return response.json();
                        }
                      })
                      .catch((error) => console.error('Error:', error));
                  });
                } else {
                  button.textContent = 'Follow';
                  button.addEventListener('click', () => {
                    fetch(`http://127.0.0.1:8000/user/follow/`, {
                      method: 'POST',
                      credentials: 'include',
                      headers: {
                        'Content-Type': 'application/json',
                      },
                      body: JSON.stringify({ user_id: pk }),
                    })
                      .then((response) => {
                        if (response.status === 201) {
                          location.reload(); // 페이지 새로고침
                        } else {
                          return response.json();
                        }
                      })
                      .catch((error) => console.error('Error:', error));
                  });
                }
                changeBtnDiv.appendChild(button);

                const tags = data['results']['User']['tags'];
                tags.forEach((tag) => {
                  const newLi = document.createElement('li');
                  const newTag = document.createElement('a');
                  newTag.setAttribute('href', '#');
                  newTag.textContent = tag;

                  newLi.appendChild(newTag);
                  tagList.appendChild(newLi);
                });
              })
              .catch((error) => {
                console.error('Failed to retrieve user data.', error);
              });

            const url =
              pk === 'me'
                ? `http://127.0.0.1:8000/user/follower/`
                : `http://127.0.0.1:8000/user/${pk}/follower/`;
            // 팔로워 목록
            fetch(url, {
              method: 'GET',
              credentials: 'include',
            })
              .then((response) => response.json())
              .then((data) => {
                // 가져온 사용자 데이터를 폼 필드에 채워줍니다.
                // 사용 예시
                const tbody = document.querySelector('#followList');
                const followers = data['Follower List'];
                followers.forEach((data) => {
                  const newTableRow = createTableRow(pk, data);
                  tbody.appendChild(newTableRow);
                });
              })
              .catch((error) => {
                console.error('Failed to retrieve user data.', error);
              });

            function createTableRow(pk, data) {
              const currentUser = data['followed_user'];
              const followingList = data['following_list'];
              const follwer = data['following_user_info'];
              const followerPk = data['following_user'];
              const tableRow = document.createElement('tr');

              // 이미지 셀 생성
              const imageCell = document.createElement('td');
              imageCell.classList.add('image', 'pt-10', 'pb-10');

              const profileImg = document.createElement('img');
              profileImg.classList.add('img-fluid');
              profileImg.style.width = '75px';
              profileImg.style.height = '75px';
              profileImg.style.borderRadius = '50%';
              if (follwer.profile_img) {
                profileImg.src = follwer.profile_img;
              } else {
                profileImg.src =
                  'https://everyplacetest.s3.ap-northeast-2.amazonaws.com/dev/user_default_clear.png';
              }
              profileImg.alt = '';

              imageCell.appendChild(profileImg);
              tableRow.appendChild(imageCell);

              // 이메일 셀 생성
              const emailCell = document.createElement('td');
              emailCell.id = 'email';
              emailCell.classList.add('description', 'pt-10', 'pb-10');
              const emailLink = document.createElement('a');
              emailLink.href = '#';
              emailLink.textContent = follwer.email;
              emailCell.appendChild(emailLink);
              tableRow.appendChild(emailCell);

              emailLink.addEventListener('click', (event) => {
                window.location.href = `user_info.html?pk=${followerPk}`;
              });
              // 닉네임 셀 생성
              const nicknameCell = document.createElement('td');
              nicknameCell.id = 'nickname';
              nicknameCell.classList.add('description', 'pt-10', 'pb-10');
              const nicknameLink = document.createElement('a');
              nicknameLink.href = '#';
              if (follwer.nickname) {
                nicknameLink.textContent = follwer.nickname;
              } else {
                nicknameLink.textContent = 'None';
              }
              nicknameCell.appendChild(nicknameLink);
              tableRow.appendChild(nicknameCell);

              // 언팔로우 버튼 셀 생성
              if (requestUserPk === currentUser) {
                const unfollowTh = document.querySelector('.Unfollow');
                if (!unfollowTh) {
                  const followTr = document.getElementById('followTr');
                  const thElement = document.createElement('th');
                  thElement.className = 'Unfollow';
                  thElement.textContent = 'Unfollow';
                  followTr.appendChild(thElement);
                }

                const unfollowCell = document.createElement('td');
                unfollowCell.classList.add('td-quantity', 'pt-10', 'pb-10');
                const unfollowLink = document.createElement('a');
                unfollowLink.id = 'unfollow';
                unfollowLink.classList.add('button');
                unfollowLink.href = '#';
                if (followingList.includes(follwer.email)) {
                  unfollowLink.textContent = 'Unfollow';
                  unfollowLink.addEventListener('click', () => {
                    fetch(`http://127.0.0.1:8000/user/follow/${followerPk}/`, {
                      method: 'DELETE',
                      credentials: 'include',
                      headers: {
                        'Content-Type': 'application/json',
                      },
                    })
                      .then((response) => {
                        if (response.status === 204) {
                          location.reload(); // 페이지 새로고침
                        } else {
                          return response.json();
                        }
                      })
                      .catch((error) => console.error('Error:', error));
                  });
                } else {
                  unfollowLink.textContent = 'Follow';
                  unfollowLink.addEventListener('click', () => {
                    fetch(`http://127.0.0.1:8000/user/follow/`, {
                      method: 'POST',
                      credentials: 'include',
                      headers: {
                        'Content-Type': 'application/json',
                      },
                      body: JSON.stringify({ user_id: followerPk }),
                    })
                      .then((response) => {
                        if (response.status === 201) {
                          location.reload(); // 페이지 새로고침
                        } else {
                          return response.json();
                        }
                      })
                      .catch((error) => console.error('Error:', error));
                  });
                }
                unfollowCell.appendChild(unfollowLink);
                tableRow.appendChild(unfollowCell);
              }
              return tableRow;
            }
          })
          .catch((error) => {
            console.error('Error:', error);
            if (error.message === 'Unauthorized') {
              window.location.href = `login.html`;
            }
          });
      });
    </script>
  </body>
</html>
