<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="keywords" content="HTML5 Template" />
    <meta
      name="description"
      content="Webster - Responsive Multi-purpose HTML5 Template"
    />
    <meta name="author" content="potenzaglobalsolutions.com" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <title>FavSpot - Notification</title>

    <!-- Favicon -->
    <link
      rel="shortcut icon"
      href="https://everyplacetest.s3.ap-northeast-2.amazonaws.com/dev/fav.png"
    />

    <!-- font -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Montserrat:300,300i,400,500,500i,600,700,800,900|Poppins:200,300,300i,400,400i,500,500i,600,600i,700,700i,800,800i,900"
    />

    <!-- Plugins -->
    <link
      rel="stylesheet"
      type="text/css"
      href="../css/template/plugins-css.css"
    />

    <!-- Typography -->
    <link
      rel="stylesheet"
      type="text/css"
      href="../css/template/typography.css"
    />

    <!-- Shortcodes -->
    <link
      rel="stylesheet"
      type="text/css"
      href="../css/template/shortcodes/shortcodes.css"
    />

    <!-- Style -->
    <link rel="stylesheet" type="text/css" href="../css/template/style.css" />
    <link rel="stylesheet" type="text/css" href="../css/pin-list.css" />

    <!-- shop -->
    <link href="../css/template/shop.css" rel="stylesheet" type="text/css" />

    <!-- Responsive -->
    <link
      rel="stylesheet"
      type="text/css"
      href="../css/template/responsive.css"
    />
  </head>

  <body>
    <div id="main-container">
      <!--=================================
shop -->

      <section class="wishlist-page page-section-ptb" style="height: 98.75%">
        <div class="container">
          <div class="row">
            <div class="col-lg-12 col-md-12">
              <div class="section-title text-center">
                <h6 class="">Check Your Notifications</h6>
                <h2 class="title-effect">Notifications</h2>
              </div>

              <div id="main" class="row">
                <div class="col-lg-3">
                  <div class="sidebar-widget">
                    <div class="team team-round full-border">
                      <div class="team-photo">
                        <img
                          id="profileImg"
                          class="img-fluid mx-auto"
                          style="object-fit: cover; width: 215px; height: 215px"
                          src="https://everyplacetest.s3.ap-northeast-2.amazonaws.com/dev/user_default_clear.png"
                          alt=""
                        />
                      </div>
                      <div class="team-description">
                        <div class="team-info">
                          <h6 id="email"></h6>
                          <span id="nickname"></span>
                        </div>
                        <div>
                          <i class="fa fa-user"></i>
                          <a id="followers" href="#">
                            <span
                              class="followers"
                              class="fw-bold small"
                            ></span>
                            <span class="small">followers</span>
                          </a>
                          <span>|</span>
                          <a id="following" href="#">
                            <span
                              class="following"
                              class="fw-bold small"
                            ></span>
                            <span class="small">following</span>
                          </a>
                          <a
                            id="unfollow"
                            class="button"
                            href="profile_edit.html"
                            >Profile Edit</a
                          >
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="sidebar-widget">
                    <h6 class="mt-40 mb-20">Tags</h6>
                    <div class="widget-tags">
                      <ul id="tagList"></ul>
                    </div>
                  </div>
                </div>
                <!-- 리스트 -->
                <div class="table-responsive col-lg-9">
                  <table class="table">
                    <thead>
                      <tr>
                        <th>Read</th>
                        <th>Message</th>
                        <th>Type</th>
                        <th>Sender</th>
                        <th>Time</th>
                        <th>Delete</th>
                      </tr>
                    </thead>
                    <tbody id="notificationList"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
    <!--=================================
shop -->

    <!--=================================
 jquery -->

    <!-- jquery -->
    <script src="../js/template/jquery-3.6.0.min.js"></script>

    <!-- plugins-jquery -->
    <script src="../js/template/plugins-jquery.js"></script>

    <!-- plugin_path -->
    <script>
      var plugin_path = '../js/template/';
    </script>

    <!-- plugins-jquery -->
    <script
      type="text/javascript"
      src="../js/template/slick/slick.min.js"
    ></script>

    <!-- custom -->
    <script src="../js/template/custom.js"></script>
    <script type="module">
      import { createPreloader } from '/frontend/assets/js/util/preloader.js';
      import { createHeader } from '/frontend/assets/js/util/header.js';
      import { createFooter } from '/frontend/assets/js/util/footer.js';
      import { submit } from '/frontend/assets/js/util/signup.js';
      createPreloader();
      createHeader();
      createFooter();
    </script>
    <script>
      const url = 'http://127.0.0.1:8000';
      const tagList = document.getElementById('tagList');

      fetch(`${url}/user/me/`, {
        method: 'GET',
        credentials: 'include',
      })
        .then((response) => response.json())
        .then((data) => {
          const requestUser = data.results.User.email;
          const requestUserPk = data.results.User.id;
          const followingList = data.results.User.following_list;
          const requestUserProfileImg = data.results.User.profile_img;

          if (requestUser) {
            const email = document.querySelector('#headerEmail');
            email.textContent = requestUser;
            if (requestUserProfileImg) {
              const profileImg = document.querySelector('.profileImg');
              profileImg.src = requestUserProfileImg;
              profileImg.style.borderRadius = '50%';
            }
          }
          const logout = document.querySelector('#logout');
          logout.addEventListener('click', (event) => {
            fetch(`http://127.0.0.1:8000/user/logout/`, {
              method: 'GET',
              credentials: 'include',
              headers: {
                'Content-Type': 'application/json',
              },
            })
              .then((response) => {
                if (response.status === 200) {
                  console.log('로그아웃 성공');
                  location.reload(); // 페이지 새로고침
                }
              })
              .catch((error) => {
                console.error('Error:', error);
              });
          });

          // 가져온 사용자 데이터를 폼 필드에 채워줍니다.
          console.log(data);
          const email = document.querySelector('#email');
          email.textContent = data['results']['User']['email'];
          const nickname = document.querySelector('#nickname');

          if (data['results']['User']['nickname']) {
            nickname.textContent = data['results']['User']['nickname'];
          } else {
            nickname.textContent = 'None';
          }
          const img = data['results']['User']['profile_img'];
          console.log(img);
          const profileImg = document.getElementById('profileImg');
          if (img) {
            profileImg.src = img;
          }
          console.log('유저', data);
          let followers = document.querySelector('.followers');
          followers.textContent = data['results']['User']['followers'];
          followers = document.querySelector('#followers');
          followers.addEventListener('click', (event) => {
            console.log('click');
            window.location.href = `follower.html`;
          });
          let following = document.querySelector('.following');
          following.textContent = data['results']['User']['following'];
          following = document.querySelector('#following');
          following.addEventListener('click', (event) => {
            window.location.href = `following.html`;
          });

          const tags = data['results']['User']['tags'];
          tags.forEach((tag) => {
            const newLi = document.createElement('li');
            const newTag = document.createElement('a');
            newTag.setAttribute('href', '#');
            newTag.textContent = tag;

            newLi.appendChild(newTag);
            tagList.appendChild(newLi);
          });
        })
        .catch((error) => {
          console.error('Failed to retrieve user data.', error);
        });

      // 알림 목록
      fetch(`${url}/notification/`, {
        method: 'GET',
        credentials: 'include',
      })
        .then((response) => response.json())
        .then((data) => {
          // 가져온 사용자 데이터를 폼 필드에 채워줍니다.
          console.log(data[0]);
          const tbody = document.querySelector('#notificationList');
          const notifications = data;
          notifications.forEach((data) => {
            const newTableRow = createTableRow(data);
            tbody.appendChild(newTableRow);
          });
        })
        .catch((error) => {
          console.error('Failed to retrieve data.', error);
        });

      function createTableRow(data) {
        const notification = data;
        const tableRow = document.createElement('tr');
        // is_read 값에 따라 배경색 클래스 추가
        if (data.is_read) {
          tableRow.classList.add('read-notification');
        }

        // 읽음 여부 셀 생성
        const readCell = document.createElement('td');
        readCell.classList.add('description', 'pt-10', 'pb-10');
        const readLink = document.createElement('div');
        if (data.is_read == true) {
          readLink.innerHTML = '<i class="fa fa-envelope-open-o"></i>';
        } else {
          readLink.innerHTML = '<i class="fa fa-envelope"></i>';
        }
        readCell.appendChild(readLink);
        tableRow.appendChild(readCell);

        // 메시지 셀 생성
        const messageCell = document.createElement('td');
        messageCell.classList.add('description', 'pt-10', 'pb-10', 'text-cell');
        const messageLink = document.createElement('a');
        messageLink.href = '#';
        messageLink.textContent = data.message;
        messageCell.appendChild(messageLink);
        tableRow.appendChild(messageCell);

        messageLink.addEventListener('click', (event) => {
          event.preventDefault();
          // is_read를 True로 변경하는 요청
          fetch(`${url}/notification/${data.id}/read/`, {
            method: 'POST',
            credentials: 'include',
            headers: {
              'Content-Type': 'application/json',
            },
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error('적절하지 않은 응답입니다');
              }

              const relatedId = data.related_url.split(',')[0];
              // 성공적으로 처리된 후 페이지 이동
              if (relatedId) {
                // 보드 관련 알림인 경우
                localStorage.setItem('selectedPk', relatedId);
                window.location.href = 'board_detail.html';
              } else {
                // 팔로우 관련 알림인 경우
                window.location.href = `user_info.html?pk=${data.sender}`;
              }
            })
            .catch((error) => console.error('error:', error));
        });

        // 알림 종류 셀 생성
        const typeCell = document.createElement('td');
        typeCell.classList.add('description', 'pt-10', 'pb-10', 'pin-cell');
        const typeLink = document.createElement('div');
        typeLink.textContent = data.related_url.split(',')[1];
        typeCell.appendChild(typeLink);
        tableRow.appendChild(typeCell);

        // 보낸 유저 이메일 셀 생성
        const senderCell = document.createElement('td');
        senderCell.classList.add('description', 'pt-10', 'pb-10', 'pin-cell');
        const senderLink = document.createElement('img');
        senderLink.classList.add('img-fluid');
        senderLink.style.width = '75px';
        senderLink.style.height = '75px';
        senderLink.style.borderRadius = '50%';
        senderLink.style.cursor = 'pointer';
        if (data.sender_profile_img) {
          senderLink.src = data.sender_profile_img;
        } else {
          senderLink.src =
            'https://everyplacetest.s3.ap-northeast-2.amazonaws.com/dev/user_default_clear.png';
        }
        senderLink.alt = '';
        senderCell.appendChild(senderLink);
        tableRow.appendChild(senderCell);

        senderLink.addEventListener('click', (event) => {
          window.location.href = `user_info.html?pk=${data.sender}`;
        });

        // 알림 시간 셀 생성
        const timeCell = document.createElement('td');
        timeCell.classList.add('description', 'pt-10', 'pb-10', 'pin-cell');
        const timeLink = document.createElement('div');

        const serverDate = new Date(data.created_at);
        const now = new Date();
        let timeText;
        if (serverDate.toDateString() === now.toDateString()) {
          // 오늘이면 시간만 표시
          const hours = String(serverDate.getHours()).padStart(2, '0');
          const minutes = String(serverDate.getMinutes()).padStart(2, '0');
          timeText = `${hours}:${minutes}`;
        } else {
          // 오늘이 아니면 날짜만 표시
          const year = serverDate.getFullYear();
          const month = String(serverDate.getMonth() + 1).padStart(2, '0'); // getMonth()는 0부터 시작하므로 +1 필요
          const date = String(serverDate.getDate()).padStart(2, '0');
          timeText = `${year}-${month}-${date}`;
        }

        timeLink.textContent = timeText;
        timeCell.appendChild(timeLink);
        tableRow.appendChild(timeCell);

        // 삭제 버튼 셀 생성
        const deleteCell = document.createElement('td');
        deleteCell.classList.add('td-quantity', 'pt-10', 'pb-10');

        const deleteButton = document.createElement('button');
        deleteButton.className = 'btn btn-danger';
        deleteButton.textContent = 'X';

        /// 삭제 버튼 클릭 이벤트
        deleteButton.addEventListener('click', () => {
          if (confirm('이 리뷰를 삭제하시겠습니까?')) {
            fetch(`${url}/notification/${data.id}/`, {
              method: 'DELETE',
              credentials: 'include',
              headers: {
                'Content-Type': 'application/json',
              },
            })
              .then((response) => {
                if (response.status === 204) {
                  tableRow.remove();
                  window.alert('알림을 삭제했습니다.');
                } else if (response.status === 403) {
                  window.alert('알림은 본인만 삭제할 수 있습니다.');
                }
              })
              .catch((error) => {
                console.error('삭제시 문제가 발생했습니다:', error);
              });
          }
        });

        deleteCell.appendChild(deleteButton);
        tableRow.appendChild(deleteCell);

        return tableRow;
      }
    </script>
  </body>
</html>
