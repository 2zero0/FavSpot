<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="keywords" content="HTML5 Template" />
    <meta
      name="description"
      content="Webster - Responsive Multi-purpose HTML5 Template"
    />
    <meta name="author" content="potenzaglobalsolutions.com" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <title>FavSpot - Notification</title>

    <!-- Favicon -->
    <link
      rel="shortcut icon"
      href="https://everyplacetest.s3.ap-northeast-2.amazonaws.com/dev/fav.png"
    />

    <!-- font -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Montserrat:300,300i,400,500,500i,600,700,800,900|Poppins:200,300,300i,400,400i,500,500i,600,600i,700,700i,800,800i,900"
    />

    <!-- Plugins -->
    <link rel="stylesheet" type="text/css" href="../css/plugins-css.css" />

    <!-- Typography -->
    <link rel="stylesheet" type="text/css" href="../css/typography.css" />

    <!-- Shortcodes -->
    <link
      rel="stylesheet"
      type="text/css"
      href="../css/shortcodes/shortcodes.css"
    />

    <!-- Style -->
    <link rel="stylesheet" type="text/css" href="../css/style.css" />
    <link rel="stylesheet" type="text/css" href="../css/pin-list.css" />

    <!-- shop -->
    <link href="../css/shop.css" rel="stylesheet" type="text/css" />

    <!-- Responsive -->
    <link rel="stylesheet" type="text/css" href="../css/responsive.css" />
  </head>

  <body>
    <div class="wrapper">
      <!--=================================
 preloader -->

      <div id="pre-loader">
        <img
          class="img-fluid d-block mx-auto"
          src="../img/pre-loader/loader-03.svg"
          alt=""
        />
      </div>

      <!--=================================
 preloader -->

      <!--=================================
 header -->

      <header
        id="header"
        class="header light logo-center"
        style="background-color: beige"
      >
        <nav
          id="menu"
          class="mega-menu d-flex align-items-center"
          style="min-height: 60px"
        >
          <!-- menu list items container -->
          <div class="col-lg-12 col-md-12">
            <!-- menu logo -->
            <div
              id="headerContent"
              class="position-relative"
              style="width: 95vw"
            >
              <a href="../../index.html">
                <img
                  id="logo_img"
                  src="https://everyplacetest.s3.ap-northeast-2.amazonaws.com/dev/big_logo.png"
                  alt="logo"
                  style="width: 80px; height: 60px"
                  class="mx-auto d-block"
                />
              </a>

              <div class="shpping-cart position-absolute top-0 end-0 mt-2">
                <a class="cart-btn" href="#">
                  <img
                    class="profileImg"
                    src="https://everyplacetest.s3.ap-northeast-2.amazonaws.com/dev/user_default_clear.png"
                    alt=""
                    style="object-fit: cover; width: 45px; height: 45px"
                  />
                </a>
                <div class="cart">
                  <div class="cart-title">
                    <h6 id="headerEmail" class="uppercase mb-0"></h6>
                  </div>
                  <div class="cart-item">
                    <div class="cart-name clearfix">
                      <a href="user_info.html">User Detail</a>
                    </div>
                  </div>
                  <div class="cart-total">
                    <a class="button" href="profile_edit.html">Profile Edit</a>
                    <a id="logout" class="button black" href="#">Logout</a>
                  </div>
                </div>
              </div>
            </div>
            <!-- menu end -->
          </div>
        </nav>
      </header>

      <!--=================================
header -->

      <!--=================================
shop -->

      <section class="wishlist-page page-section-ptb">
        <div class="container">
          <div class="row">
            <div class="col-lg-12 col-md-12">
              <div class="section-title text-center">
                <h6 class="">Check Your Notifications</h6>
                <h2 class="title-effect">Notifications</h2>
              </div>

              <div id="main" class="row">
                <div class="col-lg-3">
                  <div class="sidebar-widget">
                    <div class="team team-round full-border">
                      <div class="team-photo">
                        <img
                          id="profileImg"
                          class="img-fluid mx-auto"
                          style="object-fit: cover; width: 215px; height: 215px"
                          src="https://everyplacetest.s3.ap-northeast-2.amazonaws.com/dev/user_default_clear.png"
                          alt=""
                        />
                      </div>
                      <div class="team-description">
                        <div class="team-info">
                          <h6 id="email"></h6>
                          <span id="nickname"></span>
                        </div>
                        <div>
                          <i class="fa fa-user"></i>
                          <a id="followers" href="#">
                            <span
                              class="followers"
                              class="fw-bold small"
                            ></span>
                            <span class="small">followers</span>
                          </a>
                          <span>|</span>
                          <a id="following" href="#">
                            <span
                              class="following"
                              class="fw-bold small"
                            ></span>
                            <span class="small">following</span>
                          </a>
                          <a
                            id="unfollow"
                            class="button"
                            href="profile_edit.html"
                            >Profile Edit</a
                          >
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="sidebar-widget">
                    <h6 class="mt-40 mb-20">Tags</h6>
                    <div class="widget-tags">
                      <ul id="tagList"></ul>
                    </div>
                  </div>
                </div>
                <!-- 리스트 -->
                <div class="table-responsive col-lg-9">
                  <table class="table">
                    <thead>
                      <tr>
                        <th>Read</th>
                        <th>Message</th>
                        <th>Sender</th>
                        <th>Time</th>
                      </tr>
                    </thead>
                    <tbody id="notificationList"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!--=================================
shop -->
      <footer class="footer footer-topbar fixed-bottom">
        <div class="copyright pt-10 pb-0" style="background-color: beige">
          <div class="container m-0">
            <div
              class="row d-flex justify-content-between"
              style="width: 100vw"
            >
              <div class="col-lg-6" style="width: 550px">
                <img
                  class="img-fluid mb-10 ml-20"
                  style="height: 50px"
                  src="https://everyplacetest.s3.ap-northeast-2.amazonaws.com/dev/horizontal_logo.png"
                  alt=""
                />
                <div style="color: #555">
                  <p class="ml-20">
                    &copy;Copyright
                    <span id="copyright">
                      <script>
                        document
                          .getElementById("copyright")
                          .appendChild(
                            document.createTextNode(new Date().getFullYear())
                          );
                      </script>
                      by
                      <a href="#" style="color: #ff5757"> FavSpot. </a> </span
                    >Making Every Destination Yours.
                  </p>
                </div>
              </div>
              <div class="col-lg-6 mt-2" style="width: 550px">
                <div class="footer-social">
                  <p class="text-start text-lg-end mr-20">
                    Leave Your Mark with
                    <a href="#" style="color: #ff5757">FavSpot</a>, Everywhere
                    You Go
                  </p>
                </div>
                <div
                  class="social-icons color-hover text-start text-lg-end mt-20"
                >
                  <ul class="clearfix">
                    <li class="social-github">
                      <a
                        class="mr-20"
                        href="https://github.com/inslog94/FavSpot"
                        target="_blank"
                        ><i class="fa fa-github"></i>
                      </a>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </footer>
    </div>

    <div id="back-to-top">
      <a class="top arrow" href="#top"
        ><i class="fa fa-angle-up"></i> <span>TOP</span></a
      >
    </div>

    <!--=================================
 jquery -->

    <!-- jquery -->
    <script src="../js/jquery-3.6.0.min.js"></script>

    <!-- plugins-jquery -->
    <script src="../js/plugins-jquery.js"></script>

    <!-- plugin_path -->
    <script>
      var plugin_path = "../js/";
    </script>

    <!-- plugins-jquery -->
    <script type="text/javascript" src="../js/slick/slick.min.js"></script>

    <!-- custom -->
    <script src="../js/custom.js"></script>
    <script>
      const url = "http://127.0.0.1:8000";
      const tagList = document.getElementById("tagList");

      fetch(`${url}/user/me/`, {
        method: "GET",
        credentials: "include",
      })
        .then((response) => response.json())
        .then((data) => {
          const requestUser = data.results.User.email;
          const requestUserPk = data.results.User.id;
          const followingList = data.results.User.following_list;
          const requestUserProfileImg = data.results.User.profile_img;

          if (requestUser) {
            const email = document.querySelector("#headerEmail");
            email.textContent = requestUser;
            if (requestUserProfileImg) {
              const profileImg = document.querySelector(".profileImg");
              profileImg.src = requestUserProfileImg;
              profileImg.style.borderRadius = "50%";
            }
          }
          const logout = document.querySelector("#logout");
          logout.addEventListener("click", (event) => {
            fetch(`http://127.0.0.1:8000/user/logout/`, {
              method: "GET",
              credentials: "include",
              headers: {
                "Content-Type": "application/json",
              },
            })
              .then((response) => {
                if (response.status === 200) {
                  console.log("로그아웃 성공");
                  location.reload(); // 페이지 새로고침
                }
              })
              .catch((error) => {
                console.error("Error:", error);
              });
          });

          // 가져온 사용자 데이터를 폼 필드에 채워줍니다.
          console.log(data);
          const email = document.querySelector("#email");
          email.textContent = data["results"]["User"]["email"];
          const nickname = document.querySelector("#nickname");

          if (data["results"]["User"]["nickname"]) {
            nickname.textContent = data["results"]["User"]["nickname"];
          } else {
            nickname.textContent = "None";
          }
          const img = data["results"]["User"]["profile_img"];
          console.log(img);
          const profileImg = document.getElementById("profileImg");
          if (img) {
            profileImg.src = img;
          }
          console.log("유저", data);
          let followers = document.querySelector(".followers");
          followers.textContent = data["results"]["User"]["followers"];
          followers = document.querySelector("#followers");
          followers.addEventListener("click", (event) => {
            console.log("click");
            window.location.href = `follower.html`;
          });
          let following = document.querySelector(".following");
          following.textContent = data["results"]["User"]["following"];
          following = document.querySelector("#following");
          following.addEventListener("click", (event) => {
            window.location.href = `following.html`;
          });

          const tags = data["results"]["User"]["tags"];
          tags.forEach((tag) => {
            const newLi = document.createElement("li");
            const newTag = document.createElement("a");
            newTag.setAttribute("href", "#");
            newTag.textContent = tag;

            newLi.appendChild(newTag);
            tagList.appendChild(newLi);
          });
        })
        .catch((error) => {
          console.error("Failed to retrieve user data.", error);
        });

      // 알림 목록
      fetch(`${url}/notification/`, {
        method: "GET",
        credentials: "include",
      })
        .then((response) => response.json())
        .then((data) => {
          // 가져온 사용자 데이터를 폼 필드에 채워줍니다.
          console.log(data[0]);
          const tbody = document.querySelector("#notificationList");
          const notifications = data;
          notifications.forEach((data) => {
            const newTableRow = createTableRow(data);
            tbody.appendChild(newTableRow);
          });
        })
        .catch((error) => {
          console.error("Failed to retrieve data.", error);
        });

      function createTableRow(data) {
        const notification = data;
        const tableRow = document.createElement("tr");

        // 읽음 여부 셀 생성
        const readCell = document.createElement("td");
        readCell.classList.add("description", "pt-10", "pb-10");
        const readLink = document.createElement("div");
        if (data.is_read == true) {
          readLink.textContent = "읽음";
        } else {
          readLink.textContent = "안읽음";
        }
        readCell.appendChild(readLink);
        tableRow.appendChild(readCell);

        // 메시지 셀 생성
        const messageCell = document.createElement("td");
        messageCell.classList.add("description", "pt-10", "pb-10", "text-cell");
        const messageLink = document.createElement("a");
        messageLink.href = "#";
        messageLink.textContent = data.message;
        messageCell.appendChild(messageLink);
        tableRow.appendChild(messageCell);

        // 보낸 유저 이메일 셀 생성
        const senderCell = document.createElement("td");
        senderCell.classList.add("description", "pt-10", "pb-10", "pin-cell");
        const senderLink = document.createElement("a");
        senderLink.href = "#";
        senderLink.textContent = data.sender_email;
        senderCell.appendChild(senderLink);
        tableRow.appendChild(senderCell);

        // 알림 시간 셀 생성
        const timeCell = document.createElement("td");
        timeCell.classList.add("description", "pt-10", "pb-10", "pin-cell");
        const timeLink = document.createElement("div");

        const serverDate = new Date(data.created_at);
        const now = new Date();
        let timeText;
        if (serverDate.toDateString() === now.toDateString()) {
          // 오늘이면 시간만 표시
          const hours = String(serverDate.getHours()).padStart(2, "0");
          const minutes = String(serverDate.getMinutes()).padStart(2, "0");
          timeText = `${hours}:${minutes}`;
        } else {
          // 오늘이 아니면 날짜만 표시
          const year = serverDate.getFullYear();
          const month = String(serverDate.getMonth() + 1).padStart(2, "0"); // getMonth()는 0부터 시작하므로 +1 필요
          const date = String(serverDate.getDate()).padStart(2, "0");
          timeText = `${year}-${month}-${date}`;
        }

        timeLink.textContent = timeText;
        timeCell.appendChild(timeLink);
        tableRow.appendChild(timeCell);

        return tableRow;
      }
    </script>
  </body>
</html>
