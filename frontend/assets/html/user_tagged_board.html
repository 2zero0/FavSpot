<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="keywords" content="HTML5 Template" />
    <meta
      name="description"
      content="Webster - Responsive Multi-purpose HTML5 Template"
    />
    <meta name="author" content="potenzaglobalsolutions.com" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <title>FavSpot - User Info</title>

    <!-- Favicon -->
    <link
      rel="shortcut icon"
      href="https://favspot-fin.s3.amazonaws.com/images/default/favicon.png"
    />
    <link rel="stylesheet" href="../css/template/bootstrap.css" />
    <link rel="stylesheet" href="../css/index.css" />
    <link rel="stylesheet" href="../css/board-list.css" />
  </head>

  <body>
    <div id="main-container">
      <!--=================================
 masnary blog-->

      <section
        class="white-bg blog masonry-main"
        style="height: 98.75%; padding-top: 80px;"
      >
        <div class="container">
          <div class="row">
            <div class="col-lg-12 col-md-12">
              <div class="section-title text-center">
                <h6 class="">
                  View Your Boards with Tag - <span class="tag-name"></span>
                </h6>
                <h2 class="title-effect mt-10">Tagged Your Board</h2>
              </div>
            </div>
          </div>
          <!-- 페이지 버튼 -->
          <div class="col-lg-12">
            <nav aria-label="Page navigation example">
              <ul id="pagination" class="pagination justify-content-center">
                <li id="previousButton" class="page-item">
                  <a class="page-link" href="#"
                    ><i class="fa fa-chevron-left"></i
                  ></a>
                </li>
                <!-- 페이지 숫자 생성 공간 -->
                <li id="nextButton" class="page-item">
                  <a class="page-link" href="#"
                    ><i class="fa fa-chevron-right"></i
                  ></a>
                </li>
              </ul>
            </nav>
          </div>
          <div id="main" class="row" style="padding-bottom: 140px">
            <div class="col-lg-3">
              <div class="sidebar-widget">
                <div class="team team-round full-border">
                  <div class="team-photo">
                    <img
                      id="profileImg"
                      class="img-fluid mx-auto"
                      style="object-fit: cover; width: 215px; height: 215px"
                      src="https://favspot-fin.s3.amazonaws.com/images/default/default_user_clear.png"
                      alt=""
                    />
                  </div>
                  <div class="team-description">
                    <div class="team-info">
                      <h6 id="email"></h6>
                      <span id="nickname"></span>
                    </div>
                    <div>
                      <i class="fa fa-user"></i>
                      <a id="followers" href="#">
                        <span class="followers" class="fw-bold small"></span>
                        <span class="small">followers</span>
                      </a>
                      <span>|</span>
                      <a id="following" href="#">
                        <span class="following" class="fw-bold small"></span>
                        <span class="small">following</span>
                      </a>
                    </div>
                    <div class="changeBtn"></div>
                  </div>
                </div>
              </div>

              <div class="sidebar-widget">
                <h6 class="mt-40 mb-20">Tags</h6>
                <div class="widget-tags">
                  <ul id="tagList"></ul>
                </div>
              </div>
            </div>
            <!-- ================================== -->
            <div id="boardlist" class="col-lg-9" style="height: 800px">
              <div class="masonry columns-2">
                <div class="grid-sizer"></div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!--=================================
 masnary blog-->

    <!--=================================
 jquery -->

    <!-- jquery -->
    <script src="../js/template/jquery-3.6.0.min.js"></script>

    <!-- plugins-jquery -->
    <script src="../js/template/plugins-jquery.js"></script>

    <!-- plugin_path -->
    <script>
      var plugin_path = '../js/template/';
    </script>

    <!-- custom -->
    <script src="../js/template/custom.js"></script>
    <script type="module">
      import { loadAllScripts } from '/frontend/assets/js/util/script.js';
      import { createPreloader } from '/frontend/assets/js/util/preloader.js';
      import { createHeader } from '/frontend/assets/js/util/header.js';
      import { createFooter } from '/frontend/assets/js/util/footer.js';
      loadAllScripts();
      createPreloader();
      createHeader();
      createFooter();
    </script>
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
    <script>
      fetch(`http://127.0.0.1:8000/user/me/`, {
        method: 'GET',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json',
        },
      })
        .then((response) => response.json())
        .then((data) => {
          const requestUserPk = data.results.User.id;
          const requestUser = data.results.User.email;
          const followingList = data.results.User.following_list;

          const requestUserProfileImg = data.results.User.profile_img;

          if (requestUser) {
            const email = document.querySelector('#headerEmail');
            email.textContent = requestUser;
            const profileImg = document.querySelector('.profileImg');
            if (requestUserProfileImg) {
              profileImg.src = requestUserProfileImg;
              profileImg.style.borderRadius = '50%';
            }
          }

          const logout = document.querySelector('#logout');
          logout.addEventListener('click', (event) => {
            fetch(`http://127.0.0.1:8000/user/logout/`, {
              method: 'GET',
              credentials: 'include',
              headers: {
                'Content-Type': 'application/json',
              },
            })
              .then((response) => {
                if (response.status === 200) {
                  console.log('로그아웃 성공');
                  location.reload(); // 페이지 새로고침
                }
              })
              .catch((error) => {
                console.error('Error:', error);
              });
          });

          const params = new URLSearchParams(window.location.search);
          let pk = params.get('pk');
          if (!pk) {
            pk = 'me';
          }
          const tagList = document.getElementById('tagList');
          fetch(`http://127.0.0.1:8000/user/${pk}/`, {
            method: 'GET',
            credentials: 'include',
          })
            .then((response) => response.json())
            .then((data) => {
              // 가져온 사용자 데이터를 폼 필드에 채워줍니다.
              const currentUserPk = data['results']['User']['id'];
              const currentUser = data['results']['User']['email'];
              const email = document.querySelector('#email');
              email.textContent = currentUser;
              const nickname = document.querySelector('#nickname');

              if (data['results']['User']['nickname']) {
                nickname.textContent = data['results']['User']['nickname'];
              } else {
                nickname.textContent = 'None';
              }
              const img = data['results']['User']['profile_img'];
              const profileImg = document.getElementById('profileImg');
              console.log('img', img, !!img, profileImg);
              if (img) {
                profileImg.src = img;
              }

              let followers = document.querySelector('.followers');
              followers.textContent = data['results']['User']['followers'];
              followers = document.querySelector('#followers');
              followers.addEventListener('click', (event) => {
                window.location.href = `follower.html?pk=${currentUserPk}`;
              });

              let following = document.querySelector('.following');
              following.textContent = data['results']['User']['following'];
              following = document.querySelector('#following');
              following.addEventListener('click', (event) => {
                window.location.href = `following.html?pk=${pk}`;
              });

              const button = document.createElement('a');
              button.type = 'button';
              button.classList.add('btn', 'btn-primary', 'mt-1');
              button.style.display = 'block';
              const button2 = document.createElement('a');
              button2.type = 'button';
              button2.classList.add('btn', 'btn-primary', 'mt-1');

              // 좋아요한 보드 목록 버튼
              const button3 = document.createElement('a');
              button3.type = 'button';
              button3.classList.add(
                'btn',
                'btn-primary',
                'mt-1',
                'liked-board-btn'
              );

              // 기존 요소에 버튼 추가
              const changeBtnDiv = document.querySelector('.changeBtn');
              const params = new URLSearchParams(window.location.search);
              let followerPk = params.get('pk');

              if ((requestUser === currentUser) | (requestUserPk === pk)) {
                
                button2.textContent = 'Pin List';
                button2.style.display = 'block';
                button2.setAttribute('href', 'pin_list.html');
                
                button3.textContent = 'Liked Board';
                button3.style.display = 'block';
                button3.setAttribute(
                  'href', `user_liked_board.html?pk=${requestUserPk}`
                  );
                  
                button.textContent = 'User Info';
                button.classList.add('user-info-btn');
                button.setAttribute('href', 'user_info.html');
                changeBtnDiv.appendChild(button2);
              } else if (followingList.includes(currentUser)) {
                button.textContent = 'Unfollow';

                button3.textContent = 'Liked Board';
                button3.style.display = 'block';
                button3.setAttribute(
                  'href',
                  `user_liked_board.html?pk=${pk}`
                );

                button.addEventListener('click', () => {
                  fetch(`http://127.0.0.1:8000/user/follow/${followerPk}/`, {
                    method: 'DELETE',
                    credentials: 'include',
                    headers: {
                      'Content-Type': 'application/json',
                    },
                  })
                    .then((response) => {
                      if (response.status === 204) {
                        location.reload(); // 페이지 새로고침
                      } else {
                        return response.json();
                      }
                    })
                    .catch((error) => console.error('Error:', error));
                });
              } else {
                button.textContent = 'Follow';
                button.addEventListener('click', () => {
                  fetch(`http://127.0.0.1:8000/user/follow/`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                      'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ user_id: followerPk }),
                  })
                    .then((response) => {
                      if (response.status === 201) {
                        location.reload(); // 페이지 새로고침
                      } else {
                        return response.json();
                      }
                    })
                    .catch((error) => console.error('Error:', error));
                });
              }
              changeBtnDiv.appendChild(button3);
              changeBtnDiv.appendChild(button);

              const tags = data['results']['User']['tags'];
              tags.forEach((tag) => {
                const newLi = document.createElement('li');
                const newTag = document.createElement('a');
                newTag.setAttribute(
                  'href',
                  'user_tagged_board.html?pk=' + encodeURIComponent(pk) + '&tag=' + encodeURIComponent(tag)
                );
                newTag.textContent = tag;

                newLi.appendChild(newTag);
                tagList.appendChild(newLi);
              });

              const parentElement =
                document.querySelector('.masonry.columns-2');
              const previousButton = document.getElementById('previousButton');
              const nextButton = document.getElementById('nextButton');

              previousButton.addEventListener('click', loadPrevPage);
              nextButton.addEventListener('click', loadNextPage);

              // 초기 페이지 번호
              let currentPage = 1;

              let fetchdata;

              // 특정 태그가 등록된 유저의 보드 목록 가져오기위한 통신
              // URL의 쿼리 스트링 가져오기
              let queryString = window.location.search;

              // URLSearchParams 객체 생성
              let urlParams = new URLSearchParams(queryString);

              // 'tag' 파라미터 값 얻기
              let tag = urlParams.get('tag');

              // 'pk' 파라미터 값 얻기
              let pagePk = urlParams.get('pk');
              if (pagePk === 'me'){
                pagePk = requestUserPk;
              }

              // 페이지 상단 안내 문구에 선택된 태그 값 표기
              document.querySelector('.tag-name').textContent = tag;

              fetch(`http://127.0.0.1:8000/board/${pagePk}/tag/?tag=${tag}`, {
                credentials: 'include',
                headers: {
                  'Content-Type': 'application/json',
                },
              })
                .then((response) => response.json())
                .then((data2) => {
                  // 데이터를 보여주는 함수에 가져온 데이터 전달
                  fetchdata = data2;
                  showBoards(data2.results.boards);
                })
                .catch((error) => console.error('Error:', error));

              // 데이터를 보여주는 함수
              function showBoards(boards) {
                // 기존 데이터를 모두 제거
                while (parentElement.firstChild) {
                  parentElement.removeChild(parentElement.firstChild);
                }

                // 모든 보드 데이터 표시
                boards.forEach((board) => {
                  const dynamicBlogEntry = createBlogEntry(board);
                  parentElement.appendChild(dynamicBlogEntry);
                });

                if (fetchdata['links']['total_pages'] == 1) {
                  previousButton.style.display = 'none';
                  nextButton.style.display = 'none';
                }

                // 첫 번째 페이지일 경우 이전 페이지 버튼을 숨김
                if (currentPage === 1) {
                  previousButton.classList.add('disabled');
                } else {
                  previousButton.classList.remove('disabled');
                }

                // 다음 페이지로 이동하는 버튼을 다시 보이게 함
                if (currentPage < fetchdata['links']['total_pages']) {
                  nextButton.classList.remove('disabled');
                } else {
                  nextButton.classList.add('disabled');
                }
              }

              // 초기 데이터 표시
              // showBoards(data['results']['Boards']);

              // 다음 페이지로 이동하는 함수
              function loadNextPage() {
                if (currentPage < fetchdata['links']['total_pages']) {
                  currentPage++;
                  fetchDataAndShow();
                }
              }

              // 이전 페이지로 이동하는 함수
              function loadPrevPage() {
                if (currentPage > 1) {
                  currentPage--;
                  fetchDataAndShow();
                }
              }

              // 데이터를 가져와서 화면에 표시하는 함수
              function fetchDataAndShow() {
                fetch(`http://127.0.0.1:8000/board/${pagePk}/tag/?tag=${tag}&page=${currentPage}`, {
                  credentials: 'include',
                })
                  .then((response) => response.json())
                  .then((data) => {
                    showBoards(data.results.boards);
                  })
                  .catch((error) => {
                    console.error('Failed to load data.', error);
                  });
              }
            })
            .catch((error) => {
              console.error('Failed to retrieve user data.', error);
            });

          // 함수로 동적 생성
          function createBlogEntry(board) {
            const masonryItem = document.createElement('div');
            masonryItem.classList.add('masonry-item');

            const blogEntry = document.createElement('div');
            blogEntry.classList.add('blog-entry', 'mb-10');

            // Swiper 컨테이너를 포함하는 div를 생성합니다.
            const entryImage = document.createElement('div');
            entryImage.classList.add('entry-image', 'clearfix');

            const swiperContainer = document.createElement('div');
            swiperContainer.classList.add('swiper-container');

            // Swiper 슬라이드들을 감싸는 div를 생성합니다.
            const swiperWrapper = document.createElement('div');
            swiperWrapper.classList.add('swiper-wrapper');

            if (board.thumbnail_imgs.length === 0) {
              const swiperSlide = document.createElement('div');
              swiperSlide.classList.add('swiper-slide');

              const img = new Image(); // 이미지 엘리먼트 생성
              img.classList.add('img-fluid');
              // img.style.maxWidth = '100%'; // 이미지가 슬라이드를 넘어가지 않도록 설정
              img.style =
                'width: 100%; height: 100%; border: 3px solid #fffafa';
              img.src =
                'https://favspot-fin.s3.amazonaws.com/images/default/main_logo.png';
              img.alt = '';

              swiperSlide.appendChild(img);
              swiperWrapper.appendChild(swiperSlide);
            } else {
              // 이미지 슬라이드를 위한 반복문
              board.thumbnail_imgs.forEach((imageSrc) => {
                const swiperSlide = document.createElement('div');
                swiperSlide.classList.add('swiper-slide');

                const img = new Image(); // 이미지 엘리먼트 생성
                img.classList.add('img-fluid');
                // img.style.maxWidth = '100%'; // 이미지가 슬라이드를 넘어가지 않도록 설정
                img.style =
                  'width: 375px; height: 350px; border: 3px solid #fffafa';
                img.src = imageSrc;
                img.alt = '';

                swiperSlide.appendChild(img);
                swiperWrapper.appendChild(swiperSlide);
              });
            }

            swiperContainer.appendChild(swiperWrapper);
            entryImage.appendChild(swiperContainer);
            blogEntry.appendChild(entryImage);

            // Swiper 초기화
            initializeSwiper(swiperContainer); // Swiper 초기화 함수 호출

            const blogDetail = document.createElement('div');
            blogDetail.classList.add('blog-detail');

            const entryTitle = document.createElement('div');
            entryTitle.classList.add('entry-title', 'mb-10');
            const titleLink = document.createElement('a');
            titleLink.setAttribute('href', '#');
            titleLink.textContent = board.title;

            // 본인의 비공개 보드 표기
            const entryLock = document.createElement('span');
            if (board.is_public === false) {
              const lock = document.createElement('i');
              lock.className = 'fa fa-solid fa-lock mr-10';
              lock.style.color = '#bf6447';
              lock.style.fontSize = '22px';
              entryLock.appendChild(lock);
              entryTitle.appendChild(entryLock);
            }

            entryTitle.appendChild(titleLink);
            blogDetail.appendChild(entryTitle);

            const entryMeta = document.createElement('div');
            entryMeta.classList.add('entry-meta', 'mb-10');
            const ul = document.createElement('ul');
            const li = document.createElement('li');
            const hashTag = document.createElement('i');
            hashTag.className = 'fa fa-solid fa-hashtag';
            li.appendChild(hashTag);
            const item = document.createElement('span');
            if (board.tags.length === 0) {
              item.textContent = 'None';
            } else {
              item.textContent = board.tags.slice(0, 4).join(', ');
            }
            li.appendChild(item);

            const li2 = document.createElement('li');
            const pins = document.createElement('i');
            pins.className = 'fa fa-solid fa-map-marker';
            li2.appendChild(pins);
            const item2 = document.createElement('span');
            item2.textContent = board.pins.length;
            li2.appendChild(item2);

            const li3 = document.createElement('li');
            const star = document.createElement('i');
            star.className = 'fa fa-solid fa-star';
            li3.appendChild(star);
            const item3 = document.createElement('span');
            item3.textContent = board.likes;
            li3.appendChild(item3);

            ul.appendChild(li);
            ul.appendChild(li2);
            ul.appendChild(li3);
            entryMeta.appendChild(ul);
            blogDetail.appendChild(entryMeta);

            const entryShare = document.createElement('div');
            entryShare.classList.add('entry-share', 'clearfix');
            const entryButton = document.createElement('div');
            entryButton.classList.add('entry-button');
            const readMoreLink = document.createElement('a');
            readMoreLink.classList.add('button', 'arrow');
            readMoreLink.id = board.id;
            readMoreLink.setAttribute('href', '#');
            readMoreLink.textContent = 'Board Detail';

            readMoreLink.addEventListener('click', (event) => {
              localStorage.setItem('selectedPk', board.id);
              window.location.href = 'board_detail.html';
            });

            const arrowIcon = document.createElement('i');
            arrowIcon.classList.add('fa', 'fa-angle-right');
            readMoreLink.appendChild(arrowIcon);
            entryButton.appendChild(readMoreLink);
            entryShare.appendChild(entryButton);
            blogDetail.appendChild(entryShare);

            blogEntry.appendChild(blogDetail);
            masonryItem.appendChild(blogEntry);

            return masonryItem;
          }

          // Swiper 초기화 함수
          function initializeSwiper(container) {
            new Swiper(container, {
              loop: true,
              autoplay: {
                delay: 3000, // 각 슬라이드 간의 자동 슬라이딩 간격 (3초)
              },
              pagination: {
                el: '.swiper-pagination',
              },
              navigation: {
                nextEl: '.swiper-button-next',
                prevEl: '.swiper-button-prev',
              },
            });
          }
        })
        .catch((error) => {
          console.error('Error:', error);
          if (error.message === 'Unauthorized') {
            window.location.href = `login.html`;
          }
        });
    </script>
  </body>
</html>
