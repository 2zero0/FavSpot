<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="keywords" content="HTML5 Template" />
    <meta
      name="description"
      content="Webster - Responsive Multi-purpose HTML5 Template"
    />
    <meta name="author" content="potenzaglobalsolutions.com" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <title>FavSpot - User Profile Edit</title>

    <!-- Favicon -->
    <link
      rel="shortcut icon"
      href="https://favspot-fin.s3.amazonaws.com/images/default/favicon.png"
    />
    <link rel="stylesheet" href="../css/template/bootstrap.css" />
    <style>
      body {
        overflow: auto;
      }

      .o-hidden { 
        overflow: initial;
      }
    </style>
  </head>

  <body>
    <div id="main-container">
      <!--=================================
 Register-->

      <section
        class="white-bg page-section-ptb o-hidden pt-30"
        style="height: 98.75%"
      >
        <div class="container">
          <div class="row">
            <div class="col-lg-12 col-md-12">
              <div class="section-title text-center">
                <h6 class="">Can change your Profile and Password</h6>
                <h2 class="title-effect">User Profile Edit</h2>
              </div>
            </div>
          </div>
          <div class="row justify-content-center" style="padding-bottom: 140px;">
            <div class="col-lg-8 col-md-10">
              <div id="register-form" class="register-form">
                <form class="profileEdit" method="post">
                  <hr class="mt-50" />
                  <h4 class="title-effect mt-20 mb-20">Profile Update</h4>
                  <div class="section-field">
                    <label class="form-label" for="nickname">Nickname</label>
                    <div class="field-widget">
                      <input
                        id="nickname"
                        class="web form-control"
                        type="text"
                        placeholder="Eenter your nickname"
                        name="nickname"
                      />
                    </div>
                  </div>
                  <label class="form-label mr-3" for="profileImg"
                    >Profile Image</label
                  >
                  <div class="section-field d-flex align-items-end">
                    <img
                      id="imagePreview"
                      class="img-fluid ml-3"
                      style="
                        object-fit: cover;
                        width: 100px;
                        height: 100px;
                        border-radius: 3px;
                      "
                      src="https://favspot-fin.s3.amazonaws.com/images/default/default_user.png"
                      alt="profileImg"
                    />
                    <input
                      id="profileImg"
                      class="profileImg gui-input form-control"
                      type="file"
                      accept=".jpg, .jpeg, .png"
                      placeholder="Upload your Profile Image"
                      name="profileImg"
                    />
                  </div>

                  <div class="pwChange">
                    <hr class="mt-50" />
                    <h4 class="title-effect mt-20 mb-20">Password Change</h4>
                    <div class="section-field">
                      <label class="form-label" for="currentPassword"
                        >Current Password*
                      </label>
                      <div class="field-widget">
                        <input
                          id="currentPassword"
                          class="Password form-control"
                          type="password"
                          placeholder="Current Password"
                          name="currentPassword"
                        />
                      </div>
                    </div>
                    <div class="section-field mt-40">
                      <label class="form-label" for="newPassword1"
                        >New Password1*
                      </label>
                      <div class="field-widget">
                        <input
                          id="newPassword1"
                          class="Password form-control"
                          type="password"
                          placeholder="New Password"
                          name="newPassword1"
                        />
                      </div>
                    </div>
                    <div class="section-field">
                      <label class="form-label" for="newPassword2"
                        >New Password2*
                      </label>
                      <div class="field-widget">
                        <input
                          id="newPassword2"
                          class="Password form-control"
                          type="password"
                          placeholder="New Password Check"
                          name="newPassword2"
                        />
                      </div>
                    </div>
                    <div>
                      <p id="passwordError" class="text-danger"></p>
                    </div>
                  </div>
                  <button class="button mt-40" type="submit">
                    <span>Update</span>
                    <i class="fa fa-check"></i>
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
    <!--=================================
 Register-->

    <!--=================================
 jquery -->

    <script type="module">
      import { createPreloader } from '../js/util/preloader.js';
      import { createHeader } from '../js/util/header.js';
      import { createFooter } from '../js/util/footer.js';
      createPreloader();
      createHeader();
      createFooter();
    </script>

    <!-- jquery -->
    <script src="../js/template/jquery-3.6.0.min.js"></script>

    <!-- plugins-jquery -->
    <script src="../js/template/plugins-jquery.js"></script>

    <!-- plugin_path -->
    <script>
      var plugin_path = '../js/template/';
    </script>

    <!-- custom -->
    <script src="../js/template/custom.js"></script>

    <script>
      // 프로필 이미지 추가시 img 태그에 미리보기 추가
      document.addEventListener('DOMContentLoaded', function () {
        const profileImgInput = document.getElementById('profileImg');
        const imagePreview = document.getElementById('imagePreview');

        profileImgInput.addEventListener('change', function () {
          const selectedImage = profileImgInput.files[0];

          if (selectedImage) {
            const reader = new FileReader();
            reader.onload = function (event) {
              imagePreview.src = event.target.result;
            };
            reader.readAsDataURL(selectedImage);
          }
        });
      });

      // 비밀번호 유효성 검사
      const pwChange = document.querySelector('.pwChange');
      document.addEventListener('DOMContentLoaded', function () {
        const currentPassword = document.getElementById('currentPassword');
        const newPassword1 = document.getElementById('newPassword1');
        const newPassword2 = document.getElementById('newPassword2');
        const passwordError = document.getElementById('passwordError');
        const profileEdit = document.querySelector('.profileEdit');
        const passwordInputs = [currentPassword, newPassword1, newPassword2];

        // 쿠키 문자열 가져오기
        const cookiesString = document.cookie;

        // 쿠키 문자열을 파싱하여 객체로 변환
        const cookiesArray = cookiesString.split('; ');
        const cookies = {};

        cookiesArray.forEach((cookie) => {
          const [name, value] = cookie.split('=');
          cookies[name] = value;
        });

        // social_login 쿠키 값 가져오기
        const socialLoginCookieValue = cookies['social_login'];

        // social_login 쿠키 값이 'True'인지 'False'인지 확인
        if (socialLoginCookieValue === 'True') {
          // 소셜 로그인 상태
          pwChange.style.display = 'none';
        } else {
          // 일반 로그인 상태
          pwChange.style.display = 'block';
        }

        // 입력 이벤트를 감지하여 required 옵션을 동적으로 설정/해제
        passwordInputs.forEach((input) => {
          input.addEventListener('input', () => {
            const atLeastOneInputFilled = passwordInputs.some(
              (input) => input.value !== ''
            );

            // 모든 입력란이 비어있지 않다면 required 설정, 아니면 해제
            passwordInputs.forEach((input) => {
              input.required = atLeastOneInputFilled;
            });

            // 새로운 비밀번호 체크
            const newPassword1Value = newPassword1.value;
            const newPassword2Value = newPassword2.value;

            if (newPassword1Value && newPassword2Value) {
              if (newPassword1Value !== newPassword2Value) {
                passwordError.textContent = "Passwords don't match.";
              } else {
                passwordError.textContent = '';

                // 현재 비밀번호와 새로운 비밀번호가 같은지 체크
                if (
                  currentPassword.value === newPassword1Value ||
                  currentPassword.value === newPassword2Value
                ) {
                  passwordError.textContent =
                    'New password should be different from the current password.';
                }
              }
            }
          });
        });

        // passwordError가 있는 경우 폼 제출할 수 없게 처리
        profileEdit.addEventListener('click', function (event) {
          if (passwordError.textContent !== '') {
            event.preventDefault();
          }
        });
      });

      // 기본 프로필 값 채워주기
      document.addEventListener('DOMContentLoaded', function () {
        fetch('http://127.0.0.1:8000/user/me/', {
          method: 'GET',
          credentials: 'include',
        })
          .then((response) => response.json())
          .then((data) => {
            const requestUserPk = data.results.User.id;
            const requestUser = data.results.User.email;
            const followingList = data.results.User.following_list;

            const requestUserProfileImg = data.results.User.profile_img;

            if (requestUser) {
              const email = document.querySelector('#headerEmail');
              email.textContent = requestUser;
              const profileImg = document.querySelector('.profileImg');
              if (requestUserProfileImg) {
                profileImg.src = requestUserProfileImg;
                profileImg.style.borderRadius = '50%';
              }
            }

            // 가져온 사용자 데이터를 폼 필드에 채워줍니다.
            const nickname = (document.querySelector('#nickname').value =
              data['results']['User']['nickname']);
            const profileImg = data['results']['User']['profile_img'];
            const imagePreview = document.getElementById('imagePreview');
            if (profileImg) {
              imagePreview.src = profileImg;
            }
          })
          .catch((error) => {
            console.error('Failed to retrieve user data.', error);
          });
      });

      const $profileEdit = document.querySelector('.profileEdit');
      $profileEdit.addEventListener('submit', (event) => {
        event.preventDefault();
        console.log('제출');
        const profileImg = document.querySelector('#profileImg');
        const nickname = document.querySelector('#nickname').value;
        const currentPassword =
          document.querySelector('#currentPassword').value;
        const newPassword1 = document.querySelector('#newPassword1').value;
        const newPassword2 = document.querySelector('#newPassword2').value;

        const formData = new FormData();
        if (nickname !== '') {
          formData.append('nickname', nickname);
        }
        if (profileImg.files[0]) {
          formData.append('profile_img', profileImg.files[0]);
        }
        if (currentPassword !== '') {
          formData.append('password', currentPassword);
        }
        if (newPassword1 !== '') {
          formData.append('new_password1', newPassword1);
        }
        if (newPassword2 !== '') {
          formData.append('new_password2', newPassword2);
        }

        profileEdit(formData);
      });

      async function profileEdit(formdata) {
        const passwordError = document.getElementById('passwordError');
        try {
          const response = await fetch('http://127.0.0.1:8000/user/me/', {
            method: 'PATCH',
            body: formdata,
            credentials: 'include',
          });

          if (!response.ok) {
            const error = await response.text();
            throw new Error(error);
          }
          const data = await response.json();
          console.log(data);
          alert('Profile Update success.');
          location.reload();
        } catch (error) {
          const errData = JSON.parse(error.message);
          console.log(errData);

          for (const key in errData['err_msg']) {
            if (Array.isArray(errData['err_msg'][key])) {
              const messages = errData['err_msg'][key];
              console.log(typeof messages);
              passwordError.textContent = messages.join(' ');
            } else {
              const messages = errData['err_msg'];
              passwordError.textContent = messages;
            }
          }
        }
      }
    </script>
  </body>
</html>
